<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat with Lingu</title>
	<style>
		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			margin: 0;
			background: #b385ce;
			display: flex;
			justify-content: flex-end;
			align-items: center;
			height: 100vh;
		}

		.chat-container {
			width: 75vw;
			max-width: 1000px;
			min-height: 70vh;
			max-height: 85vh;
			margin-right: 25vw;
			margin-left: 32px;
			padding: 24px;
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 4px 24px rgba(0,0,0,0.08);
			display: flex;
			flex-direction: column;
			position: relative;
		}

		.top-bar {
			width: 100%;
			background: #e9d6fa;
			border-radius: 18px;
			padding: 18px 24px 12px 24px;
			box-sizing: border-box;
			margin-bottom: 16px;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
		}

		.top-bar-title {
			color: rgb(135, 42, 211);
			font-size: 1.7rem;
			font-weight: bold;
			margin-bottom: 4px;
		}

		.top-bar-subtitle {
			color: #2d3a4a;
			font-size: 1.1rem;
			margin-bottom: 0;
		}

		.chat-messages {
			flex: 1;
			overflow-y: auto;
			padding: 16px;
			display: flex;
			flex-direction: column;
			gap: 12px;
			margin-bottom: 80px;
		}

		.message {
			max-width: 80%;
			padding: 12px 16px;
			border-radius: 16px;
			line-height: 1.5;
			white-space: pre-wrap;
		}

		.message.user {
			align-self: flex-end;
			background: #4f8cff;
			color: white;
			border-bottom-right-radius: 4px;
		}

		.message.assistant {
			align-self: flex-start;
			background: #f3f4f6;
			color: #1f2937;
			border-bottom-left-radius: 4px;
		}

		.message.loading {
			background: #f3f4f6;
			color: #6b7280;
			font-style: italic;
		}

		.input-row {
			display: flex;
			flex-direction: row;
			align-items: center;
			width: 100%;
			position: absolute;
			left: 0;
			bottom: 24px;
			padding: 0 24px;
			box-sizing: border-box;
			gap: 12px;
		}

		.chat-input {
			flex: 1;
			min-height: 48px;
			max-height: 120px;
			padding: 12px 16px;
			font-size: 16px;
			border-radius: 10px;
			border: 2px solid #ccc;
			resize: none;
			font-family: inherit;
		}

		.chat-input:focus {
			outline: none;
			border-color: #4f8cff;
		}

		.send-btn {
			height: 48px;
			padding: 0 24px;
			background: #4f8cff;
			color: #fff;
			border: none;
			border-radius: 8px;
			font-size: 1rem;
			font-weight: bold;
			cursor: pointer;
			transition: background 0.2s;
		}

		.send-btn:hover {
			background: #2563eb;
		}

		.send-btn:disabled {
			background: #9ca3af;
			cursor: not-allowed;
		}

		.voice-btn {
			height: 48px;
			width: 48px;
			background: #10b981;
			color: #fff;
			border: none;
			border-radius: 50%;
			font-size: 1.2rem;
			cursor: pointer;
			transition: all 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.voice-btn:hover {
			background: #059669;
		}

		.voice-btn.recording {
			background: #ef4444;
			animation: pulse 1.5s ease-in-out infinite;
		}

		.voice-btn:disabled {
			background: #9ca3af;
			cursor: not-allowed;
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.6; }
		}

		.mode-toggle {
			display: flex;
			gap: 8px;
			margin-bottom: 12px;
		}

		.mode-btn {
			flex: 1;
			padding: 8px;
			border: 2px solid #e5e7eb;
			background: white;
			border-radius: 8px;
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.2s;
		}

		.mode-btn.active {
			background: #4f8cff;
			color: white;
			border-color: #4f8cff;
		}

		.voice-btn.hidden {
			display: none;
		}

		.sidebar {
			position: fixed;
			right: 32px;
			top: 50%;
			transform: translateY(-50%);
			width: 18vw;
			min-width: 200px;
			min-height: 500px;
			height: 60vh;
			background: #ffffff;
			box-shadow: -4px 0 24px rgba(0,0,0,0.06);
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			padding: 16px;
			box-sizing: border-box;
			border-radius: 24px;
		}

		.sidebar-profile {
			background: #f9fafb;
			border: 1px solid #e6e9ef;
			border-radius: 10px;
			padding: 14px;
			margin-bottom: 12px;
		}

		.sidebar-profile h3 {
			margin: 0 0 8px 0;
			color: rgb(135, 42, 211);
			font-size: 1rem;
		}

		.profile-item {
			font-size: 0.9rem;
			color: #4b5563;
			margin-bottom: 4px;
		}

		.sidebar-output {
			flex: 1;
			background: #f9fafb;
			border: 1px solid #e6e9ef;
			border-radius: 10px;
			padding: 14px;
			overflow: auto;
			color: #1f2937;
			margin-bottom: 12px;
		}

		.sidebar-image {
			height: 35%;
			min-height: 120px;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #fff;
			border-radius: 10px;
			border: 1px solid #e6e9ef;
			padding: 8px;
		}

		.sidebar-image img {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
			border-radius: 8px;
		}

		.clear-btn {
			width: 100%;
			padding: 8px;
			background: #ef4444;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 0.9rem;
			margin-top: 8px;
		}

		.clear-btn:hover {
			background: #dc2626;
		}

		@media (max-width: 900px) {
			.sidebar { display: none; }
			body { padding-right: 0; }
			.chat-container {
				width: 95vw;
				margin: 16px auto;
				margin-right: auto;
			}
		}
	</style>
</head>

<body>
	<div class="chat-container">
		<div class="top-bar">
			<div class="top-bar-title">Chat with Lingu</div>
			<div class="top-bar-subtitle">Your Personalized AI Korean Language Teacher</div>
		</div>

		<div class="mode-toggle">
			<button class="mode-btn active" id="textModeBtn" type="button">ðŸ’¬ Text</button>
			<button class="mode-btn" id="voiceModeBtn" type="button">ðŸŽ¤ Voice</button>
		</div>

		<div class="chat-messages" id="chatMessages">
			<div class="message assistant">
				Hello! I'm Lingu, your Korean language tutor. I'm here to help you practice and improve your Korean skills. What would you like to talk about today?
			</div>
		</div>

		<div class="input-row">
			<textarea
				class="chat-input"
				id="chatInput"
				placeholder="Type your message... (Press Enter to send)"
				rows="1"
			></textarea>
			<button class="voice-btn hidden" id="voiceBtn" type="button">ðŸŽ¤</button>
			<button class="send-btn" id="sendBtn" type="button">Send</button>
		</div>
	</div>

	<aside class="sidebar" aria-label="AI sidebar">
		<div class="sidebar-profile">
			<h3>Your Profile</h3>
			<div class="profile-item" id="profileLevel">Level: Loading...</div>
			<div class="profile-item" id="profileGoals">Goals: Loading...</div>
		</div>

		<div class="sidebar-output" id="sidebarOutput">
			<p style="margin:0; color:#6b7280; font-size: 0.9rem;">
				<strong>Tips:</strong><br>
				- Try typing in Korean!<br>
				- Ask questions about grammar<br>
				- Practice conversations<br>
				- Request corrections
			</p>
		</div>

		<button class="clear-btn" id="clearBtn">Clear Chat</button>

		<div class="sidebar-image">
			<img id="aiImage" src="static/imgs/c-notalk.png" alt="AI visual" />
		</div>
	</aside>

	<script>
		const chatMessages = document.getElementById('chatMessages');
		const chatInput = document.getElementById('chatInput');
		const sendBtn = document.getElementById('sendBtn');
		const voiceBtn = document.getElementById('voiceBtn');
		const clearBtn = document.getElementById('clearBtn');
		const textModeBtn = document.getElementById('textModeBtn');
		const voiceModeBtn = document.getElementById('voiceModeBtn');

		let isVoiceMode = false;
		let isRecording = false;
		let mediaRecorder = null;
		let audioChunks = [];
		let audioElement = null;

		async function loadProfile() {
			try {
				const response = await fetch('/api/user/profile');
				const data = await response.json();

				if (data.assessed) {
					document.getElementById('profileLevel').textContent = `Level: ${data.sklc_level}`;
					document.getElementById('profileGoals').textContent = `Goals: ${data.goals.join(', ') || 'Not set'}`;
				} else {
					document.getElementById('profileLevel').textContent = 'Level: Not assessed';
					document.getElementById('profileGoals').textContent = 'Complete assessment first';
				}
			} catch (error) {
				console.error('Failed to load profile:', error);
			}
		}

		function addMessage(content, role) {
			const messageDiv = document.createElement('div');
			messageDiv.className = `message ${role}`;
			messageDiv.textContent = content;
			chatMessages.appendChild(messageDiv);
			chatMessages.scrollTop = chatMessages.scrollHeight;
			return messageDiv;
		}

		async function sendMessage() {
			const message = chatInput.value.trim();
			if (!message) return;

			chatInput.disabled = true;
			sendBtn.disabled = true;

			addMessage(message, 'user');
			chatInput.value = '';

			const loadingMsg = addMessage('Lingu is typing...', 'loading');

			try {
				const response = await fetch('/api/chat', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ message })
				});

				const data = await response.json();

				loadingMsg.remove();

				if (data.success) {
					addMessage(data.response, 'assistant');
				} else {
					addMessage(`Error: ${data.error || 'Something went wrong'}`, 'assistant');
				}
			} catch (error) {
				loadingMsg.remove();
				addMessage('Error: Could not connect to the server.', 'assistant');
			}

			chatInput.disabled = false;
			sendBtn.disabled = false;
			chatInput.focus();
		}

		async function clearChat() {
			if (!confirm('Clear all chat history?')) return;

			try {
				await fetch('/api/chat/reset', { method: 'POST' });

				chatMessages.innerHTML = '';
				addMessage("Hello! I'm Lingu, your Korean language tutor. I'm here to help you practice and improve your Korean skills. What would you like to talk about today?", 'assistant');
			} catch (error) {
				console.error('Failed to clear chat:', error);
			}
		}

		function toggleMode(mode) {
			isVoiceMode = mode === 'voice';

			if (isVoiceMode) {
				textModeBtn.classList.remove('active');
				voiceModeBtn.classList.add('active');
				chatInput.classList.add('hidden');
				sendBtn.classList.add('hidden');
				voiceBtn.classList.remove('hidden');
			} else {
				voiceModeBtn.classList.remove('active');
				textModeBtn.classList.add('active');
				voiceBtn.classList.add('hidden');
				chatInput.classList.remove('hidden');
				sendBtn.classList.remove('hidden');
			}
		}

		async function initAudioRecording() {
			try {
				const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
				mediaRecorder = new MediaRecorder(stream);

				mediaRecorder.ondataavailable = (event) => {
					audioChunks.push(event.data);
				};

				mediaRecorder.onstop = async () => {
					const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
					audioChunks = [];
					await sendVoiceMessage(audioBlob);
				};

				return true;
			} catch (error) {
				console.error('Error accessing microphone:', error);
				alert('Could not access microphone. Please grant permission.');
				return false;
			}
		}

		async function toggleRecording() {
			if (!isRecording) {
				if (!mediaRecorder) {
					const success = await initAudioRecording();
					if (!success) return;
				}

				audioChunks = [];
				mediaRecorder.start();
				isRecording = true;
				voiceBtn.classList.add('recording');
				voiceBtn.textContent = 'â¹ï¸';
			} else {
				mediaRecorder.stop();
				isRecording = false;
				voiceBtn.classList.remove('recording');
				voiceBtn.textContent = 'ðŸŽ¤';
			}
		}

		async function sendVoiceMessage(audioBlob) {
			voiceBtn.disabled = true;

			const userMsg = addMessage('ðŸŽ¤ Voice message...', 'user');

			const loadingMsg = addMessage('Lingu is listening and responding...', 'loading');

			try {
				const formData = new FormData();
				formData.append('audio', audioBlob, 'recording.webm');

				const response = await fetch('/api/chat/voice', {
					method: 'POST',
					body: formData
				});

				const data = await response.json();

				loadingMsg.remove();

				if (data.success) {
					userMsg.textContent = data.transcript || 'ðŸŽ¤ Voice message';

					addMessage(data.response, 'assistant');

					if (data.audio_url) {
						await playAudioResponse(data.audio_url);
					}
				} else {
					loadingMsg.textContent = `Error: ${data.error || 'Something went wrong'}`;
				}
			} catch (error) {
				loadingMsg.remove();
				addMessage('Error: Could not process voice message.', 'assistant');
				console.error('Voice message error:', error);
			}

			voiceBtn.disabled = false;
		}

		async function playAudioResponse(audioUrl) {
			if (audioElement) {
				audioElement.pause();
				audioElement = null;
			}

			audioElement = new Audio(audioUrl);
			try {
				await audioElement.play();
			} catch (error) {
				console.error('Error playing audio:', error);
			}
		}

		sendBtn.addEventListener('click', sendMessage);
		voiceBtn.addEventListener('click', toggleRecording);
		textModeBtn.addEventListener('click', () => toggleMode('text'));
		voiceModeBtn.addEventListener('click', () => toggleMode('voice'));

		chatInput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});

		clearBtn.addEventListener('click', clearChat);

		chatInput.addEventListener('input', () => {
			chatInput.style.height = 'auto';
			chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
		});

		loadProfile();
	</script>
</body>
</html>
